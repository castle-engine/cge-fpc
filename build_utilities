# ------------------------------------------------------------------------
# bash utilities useful both when building FPC and Lazarus.
# Use them by "source build_utilities" in bash scripts.
#
# They are adjusted to be used in "bash strict mode",
# http://redsymbol.net/articles/unofficial-bash-strict-mode/ ,
# so they don't read potentially undefined variables etc.
# ------------------------------------------------------------------------

# Determine variables used in other places of the script.
utils_setup_environment ()
{
  # calculate WORKSPACE_ROOT and WORKSPACE_ROOT_UNIX.
  # On Windows they differ:
  # - WORKSPACE_ROOT_UNIX is in Cygwin path format (with /, without :, more suitable for $PATH)
  # - WORKSPACE_ROOT is in native (on Windows) path format, understood also by non-Msys2/Cygwin tools
  WORKSPACE_ROOT_UNIX="`pwd`"
  WORKSPACE_ROOT="${WORKSPACE_ROOT_UNIX}"
  if which cygpath > /dev/null; then
    WORKSPACE_ROOT="`cygpath --mixed \"${WORKSPACE_ROOT}\"`"
  fi

  # calculate IS_UNIX, IS_WINDOWS (happen to be negation of each other now)
  if [ "${OS}" = "win64" -o "${OS}" = "win32" ]; then
    IS_UNIX=false
    IS_WINDOWS=true
  else
    IS_UNIX=true
    IS_WINDOWS=false
  fi

  echo "build_utilities: Variables calculated:"
  echo "  IS_UNIX: ${IS_UNIX}"
  echo "  IS_WINDOWS: ${IS_WINDOWS}"
  echo "  WORKSPACE_ROOT_UNIX: ${WORKSPACE_ROOT_UNIX}"
  echo "  WORKSPACE_ROOT: ${WORKSPACE_ROOT}"
  echo
}

# Use this on Windows, around executing "make ..." with Makefile generated
# by FPCMake.
# Makefile generated by FPCMake has a few problems on Windows, unless it
# uses exactly the utilities as provided by FPC.
# Make sure to restore $PATH to $RESTORE_PATH later.
utils_download_and_setup_fpc_build_resources ()
{
  # Makefile inside FPC has a few problems on Windows.
  #
  # Summary:
  # It's easiest to just avoid them by using utilities (like pwd.exe)
  # distributed by FPC (here we just reuse them from FPC 3.2.2 installation)
  # and relying they are placed in a directory without spaces (which is true
  # at least on GH-hosted Windows runners).
  # That's what we now do.
  #
  # Past problems and attempts:
  #
  # 1. At times, FPC Makefile wants native path (not MSys2/Cygwin path).
  #    This is understandable, but then they try to obtain it by looking for
  #    /cygdrive prefix and search+replace in Makefile, instead of using more
  #    reliable "cygpath --mixed ..." to convert paths. The latter would work
  #    on both MSys2 and Cygwin, and would work for all paths, e.g. /home/...
  #    (which doesn't start with /cygdrive but is still a Cygwin path).
  #
  #    Failing to solve it may result in "make ..." error, and FPC saying it cannot
  #    find unit system used by pp. You will see it is passing -Fu/cygwin/path
  #    to ppc*, and thus it's a Cygwin path.
  #
  # 2. Makefile inside FPC has problems when `pwd.exe` is present in a directory
  #    with space in path.
  #    The Makefile does PWD:=$(strip $(wildcard $(addsuffix /pwd,$(SEARCHPATH))))
  #    and will fail to find PWD when there is space in path.
  #    And this is the case on GH-hosted Windows runner, where pwd.exe
  #    is inside "C:/Program Files/Git/usr/bin/".
  #
  #    They could have used "which pwd", which would be more reliable, but didn't...
  #
  #    Symptom: "make ..." fails with "You need the GNU utils package to use this Makefile".
  #
  #    Solution is to use our ${WORKSPACE_ROOT_UNIX}/fpc-build-resources/install/binwXX .

  git clone https://gitlab.com/freepascal.org/fpc/build.git \
    -c advice.detachedHead=false \
    --depth 1 --single-branch --branch main fpc-build-resources

  # check the layout of fpc build repo on
  # https://gitlab.com/freepascal.org/fpc/build/-/tree/main/install?ref_type=heads
  local FPC_BUILD_OS_SUBDIR
  case "${CPU}" in
    x86_64) FPC_BUILD_OS_SUBDIR=binw64 ;;
    i386)   FPC_BUILD_OS_SUBDIR=binw32 ;;
    *)
      echo "Cannot find FPC_BUILD_OS_SUBDIR for this CPU: ${CPU}"
      exit 1
      ;;
  esac

  # Restore $PATH later, as the FPC utilities are weirdly old.
  # E.g. `mv.exe` is some archaic version that doesn't tolerate last
  # parameter having final slash (would fail at "mv ... fpc/bin/",
  # while the standard "mv" from both MSys2 (in GHA) and Cygwin can handle it).
  RESTORE_PATH="$PATH"

  # Note that we need to append here to PATH using WORKSPACE_ROOT_UNIX,
  # not WORKSPACE_ROOT, as in MSys/Cygwin, : is path separator
  # (not drive letter separator).
  export PATH="${WORKSPACE_ROOT_UNIX}/fpc-build-resources/install/${FPC_BUILD_OS_SUBDIR}/:$PATH"
}

# Calculate $FPC_OPTS, white-space-separated FPC options,
# to use for FPC building, and later to build applications
# (test_program.lpr in castle-fpc, or Lazarus later in castle-lazarus).
utils_calculate_fpc_opts ()
{
  FPC_OPTS=''

  # Add macOS specific flags, otherwise linking on newer macOS versions fails.
  if [ "${OS}" = "darwin" ]; then

    # This is following FpcUpDeluxe:
    # MacOS 10.14 Mojave and newer have libs and tools in new, yet non-standard directory
    MAC_SDK="`xcrun --show-sdk-path`"
    MAC_XCODE="`xcode-select --print-path`"
    FPC_OPTS="${FPC_OPTS} -XR${MAC_SDK} -Fl${MAC_SDK}/usr/lib -FD${MAC_XCODE}/Toolchains/XcodeDefault.xctoolchain/usr/bin"

    # Linking GUI applications on newer macOS, with Aarch64,
    # requires -WMxxx (it is also OK on x86_64).
    #
    # While some non-GUI applications (like fpc or CGE build tool) don't need it,
    # but then we have a flood of linking warnings about FPC and CGE units:
    # "ld: warning: object file (.....o) was built for newer 'macOS' version (11.0) than being linked (10.15)"
    # So it's better to use -WMxxx below always.
    #
    # See also fpcupdeluxe logic:
    # https://github.com/LongDirtyAnimAlf/fpcupdeluxe/blob/63228f718e24e0a5e77c8f5b70e269ba92393b9d/sources/crossinstallers/m_darwin_to_apple_base.pas#L232
    # Some discussion in:
    # https://gitlab.com/freepascal.org/lazarus/lazarus/-/issues/41570
    MAC_SDK_VERSION="`xcrun --show-sdk-version`"
    echo "macOS SDK version is ${MAC_SDK_VERSION}, assuming it is >= 11.0."
    FPC_OPTS="${FPC_OPTS} -WM10.15"
  fi
}

