# ----------------------------------------------------------------------------
# GitHub Action workflow to build FPC to be
# bundled with CGE downloads on https://castle-engine.io/download .
#
# See https://docs.github.com/en/actions for docs.
# ----------------------------------------------------------------------------

name: Build

# workflow_dispatch allows to call it manually
# See https://docs.github.com/en/actions/using-workflows/manually-running-a-workflow
on: [push, pull_request, workflow_dispatch]

defaults:
  run:
    shell: bash

jobs:
  build:
    name: Build
    strategy:
      matrix:
        runner: [
          ubuntu-latest,
          windows-latest,
          # last macOS using Intel
          macos-15-intel,
          macos-latest
        ]
        include:
          # Set matrix.fpc_os, matrix.fpc_cpu .
          # These are OS and CPU names following FPC naming convention,
          # exactly as if from
          # - fpc -iTO / -iSO (target/source OS)
          # - fpc -iTP / -iSP (target/source CPU)
          # They describe both source and target OS/CPU in our scenario.
          - fpc_os: linux
            fpc_cpu: x86_64
          - runner: windows-latest
            fpc_os: win64
            fpc_cpu: x86_64
          - runner: macos-latest
            fpc_os: darwin
            fpc_cpu: aarch64
          - runner: macos-15-intel
            fpc_os: darwin
            fpc_cpu: x86_64

    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v6

      # Old approach:
      # Get last stable FPC to bootstrap.
      # Now: This is no longer used: we rely fully on our bootstrap-fpc/ subdirectory.
      #
      # - name: Install FPC+Lazarus (not macOS)
      #   if: ${{ ! matrix.is_macos }}
      #   uses: gcarreno/setup-lazarus@v3.3.1
      #   with:
      #     lazarus-version: stable
      #
      # - name: Install FPC+Lazarus (macOS)
      #   if: ${{ matrix.is_macos }}
      #   run: brew install fpc

      - name: Build FPC
        run: ./build_fpc ${FPC_OS} ${FPC_CPU}

      # Old approach:
      # Get artifacts.
      # No need for this now. This job just updates GH release "snapshot",
      # and other things (like CGE build with bundled FPC) can just download it.
      # - name: Archive Artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: fpc-${{ matrix.fpc_os }}-${{ matrix.fpc_cpu }}-release
      #     path: "fpc-*.zip"
      #     if-no-files-found: error

      - name: Release Artifacts
        if: ${{ github.ref == 'refs/heads/master' }}
        run: gh release --repo castle-engine/cge-fpc upload snapshot --clobber fpc-*.zip
        env:
          GH_TOKEN: ${{ github.token }}
